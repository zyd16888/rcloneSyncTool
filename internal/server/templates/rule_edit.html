{{define "content"}}
<div class="space-y-4">
  <div>
    <h1 class="text-xl font-bold">编辑规则</h1>
    <div class="text-sm opacity-70">每条规则独立运行；copy 不删源端，move 成功后删除源端</div>
  </div>

  {{if .Error}}
  <div class="alert alert-warning">
    <span><b>提示：</b>{{.Error}} 你仍可手动输入 remote 名称，但扫描/传输时 rclone 必须能解析到该 remote。</span>
  </div>
  {{end}}

  <div class="card bg-base-100 border border-base-200">
    <div class="card-body">
      <form method="post" action="/rules/save" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="form-control">
            <div class="label"><span class="label-text">规则 ID</span></div>
            <input type="text" name="id" value="{{.Rule.ID}}" placeholder="例如：ruleA" autocomplete="off" class="input input-bordered">
          </label>

          <label class="form-control">
            <div class="label"><span class="label-text">启用</span></div>
            <select name="enabled" class="select select-bordered">
              <option value="1" {{if .Rule.Enabled}}selected{{end}}>是</option>
              <option value="0" {{if .Rule.Enabled}}{{else}}selected{{end}}>否</option>
            </select>
            <div class="label"><span class="label-text-alt opacity-70">启用后会按扫描策略自动运行</span></div>
          </label>

          <label class="form-control">
            <div class="label"><span class="label-text">源类型</span></div>
            <select name="src_kind" id="srcKind" class="select select-bordered">
              <option value="remote" {{if eq .Rule.SrcKind "remote"}}selected{{end}}>remote（远端）</option>
              <option value="local" {{if eq .Rule.SrcKind "local"}}selected{{end}}>local（本地目录）</option>
            </select>
          </label>

          <label class="form-control">
            <div class="label"><span class="label-text">模式</span></div>
            <select name="transfer_mode" class="select select-bordered">
              <option value="copy" {{if eq .Rule.TransferMode "copy"}}selected{{end}}>copy（不删除源端）</option>
              <option value="move" {{if eq .Rule.TransferMode "move"}}selected{{end}}>move（成功后删除源端）</option>
            </select>
          </label>
        </div>

        <div id="srcRemoteFields" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="form-control">
            <div class="label"><span class="label-text">源端 remote</span></div>
            <input type="text" id="srcRemote" name="src_remote" value="{{.Rule.SrcRemote}}" list="remoteList" autocomplete="off" class="input input-bordered" placeholder="例如：src">
          </label>
          <label class="form-control">
            <div class="label"><span class="label-text">src_path</span></div>
            <input type="text" id="srcPath" name="src_path" value="{{.Rule.SrcPath}}" placeholder="/Source/A" autocomplete="off" class="input input-bordered" list="srcPathList">
            <div class="label"><span class="label-text-alt opacity-70">源端目录（相对于 src_remote 的根）。</span></div>
          </label>
        </div>

        <div id="srcLocalFields" class="space-y-2" style="display:none">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label class="form-control">
              <div class="label"><span class="label-text">本地目录</span></div>
              <input type="text" id="srcLocalRoot" name="src_local_root" value="{{.Rule.SrcLocalRoot}}" placeholder="例如：D:\\data\\watch 或 /data/watch" autocomplete="off" class="input input-bordered" list="localPathList">
              <div class="label"><span class="label-text-alt opacity-70">扫描/传输时以该目录作为源根目录。</span></div>
            </label>
            <label class="form-control">
              <div class="label"><span class="label-text">本地监控</span></div>
              <select name="local_watch_enabled" class="select select-bordered">
                <option value="1" {{if .Rule.LocalWatch}}selected{{end}}>开</option>
                <option value="0" {{if .Rule.LocalWatch}}{{else}}selected{{end}}>关</option>
              </select>
              <div class="label"><span class="label-text-alt opacity-70">监听变更触发快速扫描（仍会按扫描间隔兜底）</span></div>
            </label>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="form-control">
            <div class="label"><span class="label-text">目标端 remote</span></div>
            <input type="text" id="dstRemote" name="dst_remote" value="{{.Rule.DstRemote}}" list="remoteList" autocomplete="off" class="input input-bordered" placeholder="例如：dst">
          </label>
          <label class="form-control">
            <div class="label"><span class="label-text">dst_path</span></div>
            <input type="text" id="dstPath" name="dst_path" value="{{.Rule.DstPath}}" placeholder="/Backup/A" autocomplete="off" class="input input-bordered" list="dstPathList">
          </label>
        </div>

        <datalist id="remoteList">
          {{range .Remotes}}<option value="{{.}}"></option>{{end}}
        </datalist>
        <datalist id="srcPathList"></datalist>
        <datalist id="dstPathList"></datalist>
        <datalist id="localPathList"></datalist>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <label class="form-control">
            <div class="label"><span class="label-text">限速</span></div>
            <input type="text" name="bwlimit" value="{{.Rule.Bwlimit}}" class="input input-bordered" placeholder="例如：8M / 1.5M / 0 / 留空">
            <div class="label"><span class="label-text-alt opacity-70">对应 rclone 的 <code>--bwlimit</code>；留空使用系统默认。</span></div>
          </label>

          <label class="form-control">
            <div class="label"><span class="label-text">最小文件</span></div>
            <input type="text" name="min_file_size" value="{{if gt .Rule.MinFileSizeBytes 0}}{{.Rule.MinFileSizeBytes}}{{end}}" class="input input-bordered" placeholder="例如：10M / 1.5G / 0 / 留空">
            <div class="label"><span class="label-text-alt opacity-70">小于该大小的文件不会传输；当前：{{if gt .Rule.MinFileSizeBytes 0}}<code>{{humanBytes .Rule.MinFileSizeBytes}}</code>{{else}}不限制{{end}}</span></div>
          </label>

          <label class="form-control">
            <div class="label"><span class="label-text">并发</span></div>
            <input type="number" name="max_parallel_jobs" value="{{.Rule.MaxParallelJobs}}" class="input input-bordered">
            <div class="label"><span class="label-text-alt opacity-70">本规则同时运行的任务数（与“系统设置-总并发”共同生效）。</span></div>
          </label>
        </div>

        <label class="form-control">
          <div class="label"><span class="label-text">自定义参数(可选)（rclone）</span></div>
          <textarea name="rclone_extra_args" rows="3" class="textarea textarea-bordered font-mono text-xs" placeholder='例如：--exclude "*.tmp" --drive-acknowledge-abuse'>{{.Rule.RcloneExtraArgs}}</textarea>
          <div class="label">
            <span class="label-text-alt opacity-70">仅对 copy/move 生效；支持引号；会自动屏蔽 <code>--rc*</code>/<code>--stats*</code>/<code>--log-file</code>/<code>--files-from</code>/<code>--config</code> 等参数。</span>
          </div>
        </label>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <label class="form-control">
            <div class="label"><span class="label-text">扫描间隔（秒）</span></div>
            <input type="number" name="scan_interval_sec" value="{{.Rule.ScanIntervalSec}}" class="input input-bordered">
          </label>
          <label class="form-control">
            <div class="label"><span class="label-text">稳定秒数</span></div>
            <input type="number" name="stable_seconds" value="{{.Rule.StableSeconds}}" class="input input-bordered">
          </label>
          <label class="form-control">
            <div class="label"><span class="label-text">批大小</span></div>
            <input type="number" name="batch_size" value="{{.Rule.BatchSize}}" class="input input-bordered">
          </label>
        </div>

        <div class="flex gap-2">
          <button class="btn btn-info text-info-content" type="submit">保存</button>
          <a class="btn btn-ghost" href="/rules">返回</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function applySrcKind(kind) {
    const isLocal = kind === "local";
    const a = document.getElementById("srcRemoteFields");
    const b = document.getElementById("srcLocalFields");
    if (a) a.style.display = isLocal ? "none" : "";
    if (b) b.style.display = isLocal ? "" : "none";
  }

  function debounce(fn, ms) {
    let t = null;
    return (...args) => {
      if (t) clearTimeout(t);
      t = setTimeout(() => fn(...args), ms);
    };
  }

  function setDatalistOptions(datalist, values) {
    if (!datalist) return;
    datalist.innerHTML = "";
    for (const v of values || []) {
      const opt = document.createElement("option");
      opt.value = v;
      datalist.appendChild(opt);
    }
  }

  function bindLocalDirSuggest(input, datalist) {
    if (!input || !datalist) return;
    let ctrl = null;
    const run = async () => {
      const p = (input.value || "").trim();
      if (!p) {
        setDatalistOptions(datalist, []);
        return;
      }
      if (ctrl) ctrl.abort();
      ctrl = new AbortController();
      try {
        const r = await fetch("/api/fs/list?path=" + encodeURIComponent(p), { signal: ctrl.signal });
        if (!r.ok) {
          setDatalistOptions(datalist, []);
          return;
        }
        const j = await r.json();
        setDatalistOptions(datalist, Array.isArray(j.suggestions) ? j.suggestions : []);
      } catch (e) {
        if (e && e.name === "AbortError") return;
        setDatalistOptions(datalist, []);
      }
    };
    const deb = debounce(run, 200);
    input.addEventListener("input", deb);
    input.addEventListener("focus", run);
  }

  function bindRemoteDirSuggest(remoteInput, pathInput, datalist) {
    if (!remoteInput || !pathInput || !datalist) return;
    let ctrl = null;
    const run = async () => {
      const remote = (remoteInput.value || "").trim();
      const p = pathInput.value || "";
      if (!remote) {
        setDatalistOptions(datalist, []);
        return;
      }
      if (ctrl) ctrl.abort();
      ctrl = new AbortController();
      const url = "/api/rclone/dirs?remote=" + encodeURIComponent(remote) + "&path=" + encodeURIComponent(p);
      try {
        const r = await fetch(url, { signal: ctrl.signal });
        if (!r.ok) {
          setDatalistOptions(datalist, []);
          return;
        }
        const j = await r.json();
        setDatalistOptions(datalist, Array.isArray(j.suggestions) ? j.suggestions : []);
      } catch (e) {
        if (e && e.name === "AbortError") return;
        setDatalistOptions(datalist, []);
      }
    };
    const deb = debounce(run, 200);
    remoteInput.addEventListener("input", deb);
    pathInput.addEventListener("input", deb);
    pathInput.addEventListener("focus", run);
  }

  const srcKind = document.getElementById("srcKind");
  if (srcKind) {
    applySrcKind(srcKind.value || "remote");
    srcKind.addEventListener("change", (e) => applySrcKind(e.target.value));
  }

  bindLocalDirSuggest(document.getElementById("srcLocalRoot"), document.getElementById("localPathList"));
  bindRemoteDirSuggest(document.getElementById("srcRemote"), document.getElementById("srcPath"), document.getElementById("srcPathList"));
  bindRemoteDirSuggest(document.getElementById("dstRemote"), document.getElementById("dstPath"), document.getElementById("dstPathList"));
</script>
{{end}}
