{{define "content"}}
<div class="space-y-4">
  <div>
    <h1 class="text-xl font-bold">手动运行</h1>
    <div class="text-sm opacity-70">不创建同步队列，直接启动一次 rclone 任务（copy/move）；运行记录会出现在任务列表中</div>
  </div>

  <div class="card bg-base-100 border border-base-200">
    <div class="card-body py-3">
      <div class="flex items-center gap-2">
        <span class="text-sm font-bold">从现有规则导入配置：</span>
        <select class="select select-bordered select-sm w-full max-w-xs" onchange="if(this.value) window.location.href='/manual?copy_from_id='+encodeURIComponent(this.value);">
          <option value="">-- 请选择规则 --</option>
          {{range .Rules}}
            <option value="{{.ID}}" {{if eq .ID $.Rule.ID}}selected{{end}}>{{.ID}}</option>
          {{end}}
        </select>
      </div>
    </div>
  </div>

  {{if .Error}}
  <div class="alert alert-warning">
    <span><b>提示：</b>{{.Error}} 你仍可手动输入 remote 名称，但运行时 rclone 必须能解析到该 remote。</span>
  </div>
  {{end}}

  <div class="card bg-base-100 border border-base-200">
    <div class="card-body">
      <form method="post" action="/manual/start" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="form-control">
            <div class="label"><span class="label-text">源类型</span></div>
            <select name="src_kind" id="srcKind" class="select select-bordered">
              <option value="remote" {{if ne .Rule.SrcKind "local"}}selected{{end}}>remote（远端）</option>
              <option value="local" {{if eq .Rule.SrcKind "local"}}selected{{end}}>local（本地目录）</option>
            </select>
          </label>
          <label class="form-control">
            <div class="label"><span class="label-text">模式</span></div>
            <select name="transfer_mode" class="select select-bordered">
              <option value="copy" {{if ne .Rule.TransferMode "move"}}selected{{end}}>copy（不删除源端）</option>
              <option value="move" {{if eq .Rule.TransferMode "move"}}selected{{end}}>move（成功后删除源端）</option>
            </select>
          </label>
        </div>

        <div id="srcRemoteFields" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="form-control">
            <div class="label"><span class="label-text">源端 remote</span></div>
            <input type="text" id="srcRemote" name="src_remote" list="remoteList" autocomplete="off" class="input input-bordered" placeholder="例如：src" value="{{.Rule.SrcRemote}}">
          </label>
          <label class="form-control">
            <div class="label"><span class="label-text">src_path</span></div>
            <input type="text" id="srcPath" name="src_path" placeholder="/Source/A" autocomplete="off" class="input input-bordered" list="srcPathList" value="{{.Rule.SrcPath}}">
          </label>
        </div>

        <div id="srcLocalFields" class="grid grid-cols-1 md:grid-cols-2 gap-4" style="display:none">
          <label class="form-control md:col-span-2">
            <div class="label"><span class="label-text">本地目录</span></div>
            <input type="text" id="srcLocalRoot" name="src_local_root" placeholder="例如：D:\\data\\watch 或 /data/watch" autocomplete="off" class="input input-bordered" list="localPathList" value="{{.Rule.SrcLocalRoot}}">
          </label>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="form-control">
            <div class="label"><span class="label-text">目标端 remote</span></div>
            <input type="text" id="dstRemote" name="dst_remote" list="remoteList" autocomplete="off" class="input input-bordered" placeholder="例如：dst" value="{{.Rule.DstRemote}}">
          </label>
          <label class="form-control">
            <div class="label"><span class="label-text">dst_path</span></div>
            <input type="text" id="dstPath" name="dst_path" placeholder="/Backup/A" autocomplete="off" class="input input-bordered" list="dstPathList" value="{{.Rule.DstPath}}">
          </label>
        </div>

        <datalist id="remoteList">
          {{range .Remotes}}<option value="{{.}}"></option>{{end}}
        </datalist>
        <datalist id="srcPathList"></datalist>
        <datalist id="dstPathList"></datalist>
        <datalist id="localPathList"></datalist>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="form-control">
            <div class="label"><span class="label-text">限速</span></div>
            <input type="text" name="bwlimit" class="input input-bordered" placeholder="例如：8M / 1.5M / 0 / 留空" value="{{.Rule.Bwlimit}}">
            <div class="label"><span class="label-text-alt opacity-70">对应 rclone 的 <code>--bwlimit</code>；留空使用系统默认。</span></div>
          </label>
          <label class="form-control">
            <div class="label"><span class="label-text">最小文件</span></div>
            <input type="text" name="min_file_size" class="input input-bordered" placeholder="例如：10M / 1.5G / 0 / 留空" value="{{if gt .Rule.MinFileSizeBytes 0}}{{humanBytes .Rule.MinFileSizeBytes}}{{end}}">
            <div class="label"><span class="label-text-alt opacity-70">小于该大小的文件不会传输（等同 rclone <code>--min-size</code>）。</span></div>
          </label>
        </div>

        <label class="form-control">
          <div class="label">
            <span class="label-text">忽略扩展名(可选)</span>
            <select class="select select-bordered select-xs" onchange="appendPreset(this)">
              <option value="">+ 添加预设...</option>
              {{range .Presets}}
              <option value="{{.Extensions}}">{{.Name}}</option>
              {{end}}
            </select>
          </div>
          <input type="text" name="ignore_extensions" value="{{.Rule.IgnoreExtensions}}" class="input input-bordered" placeholder="例如：.url .html .tmp">
          <div class="label"><span class="label-text-alt opacity-70">多个扩展名用空格分隔；这些文件将不会被传输。</span></div>
        </label>
        <script>
          function appendPreset(select) {
            const val = select.value;
            if (!val) return;
            const input = document.querySelector('[name=ignore_extensions]');
            const current = new Set((input.value || "").trim().split(/\s+/).filter(x => x));
            const toAdd = val.trim().split(/\s+/).filter(x => x);
            toAdd.forEach(x => current.add(x));
            input.value = Array.from(current).join(' ');
            select.value = "";
          }
        </script>

        <label class="form-control">
          <div class="label"><span class="label-text">自定义参数(可选)（rclone）</span></div>
          <textarea name="rclone_extra_args" rows="3" class="textarea textarea-bordered font-mono text-xs w-full" style="border:1px solid rgba(187, 197, 211, 0.35);padding:.75rem 1rem;border-radius:.5rem;" placeholder='例如：--exclude "*.tmp" --drive-acknowledge-abuse'>{{.Rule.RcloneExtraArgs}}</textarea>
          <div class="label">
            <span class="label-text-alt opacity-70">仅对 copy/move 生效；支持引号；会自动屏蔽 <code>--rc*</code>/<code>--stats*</code>/<code>--log-file</code>/<code>--files-from</code>/<code>--config</code> 等参数。</span>
          </div>
        </label>

        <div class="flex gap-2">
          <button class="btn btn-info text-info-content" type="submit">立即运行</button>
          <a class="btn btn-ghost" href="/rules">返回</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function applySrcKind(kind) {
    const isLocal = kind === "local";
    const a = document.getElementById("srcRemoteFields");
    const b = document.getElementById("srcLocalFields");
    if (a) a.style.display = isLocal ? "none" : "";
    if (b) b.style.display = isLocal ? "" : "none";
  }

  function debounce(fn, ms) {
    let t = null;
    return (...args) => {
      if (t) clearTimeout(t);
      t = setTimeout(() => fn(...args), ms);
    };
  }

  function setDatalistOptions(datalist, values) {
    if (!datalist) return;
    datalist.innerHTML = "";
    for (const v of values || []) {
      const opt = document.createElement("option");
      opt.value = v;
      datalist.appendChild(opt);
    }
  }

  function bindLocalDirSuggest(input, datalist) {
    if (!input || !datalist) return;
    let ctrl = null;
    const run = async () => {
      const p = (input.value || "").trim();
      if (!p) {
        setDatalistOptions(datalist, []);
        return;
      }
      if (ctrl) ctrl.abort();
      ctrl = new AbortController();
      try {
        const r = await fetch("/api/fs/list?path=" + encodeURIComponent(p), { signal: ctrl.signal });
        if (!r.ok) {
          setDatalistOptions(datalist, []);
          return;
        }
        const j = await r.json();
        setDatalistOptions(datalist, Array.isArray(j.suggestions) ? j.suggestions : []);
      } catch (e) {
        if (e && e.name === "AbortError") return;
        setDatalistOptions(datalist, []);
      }
    };
    const deb = debounce(run, 200);
    input.addEventListener("input", deb);
    input.addEventListener("focus", run);
  }

  function bindRemoteDirSuggest(remoteInput, pathInput, datalist) {
    if (!remoteInput || !pathInput || !datalist) return;
    let ctrl = null;
    const run = async () => {
      const remote = (remoteInput.value || "").trim();
      const p = pathInput.value || "";
      if (!remote) {
        setDatalistOptions(datalist, []);
        return;
      }
      if (ctrl) ctrl.abort();
      ctrl = new AbortController();
      const url = "/api/rclone/dirs?remote=" + encodeURIComponent(remote) + "&path=" + encodeURIComponent(p);
      try {
        const r = await fetch(url, { signal: ctrl.signal });
        if (!r.ok) {
          setDatalistOptions(datalist, []);
          return;
        }
        const j = await r.json();
        setDatalistOptions(datalist, Array.isArray(j.suggestions) ? j.suggestions : []);
      } catch (e) {
        if (e && e.name === "AbortError") return;
        setDatalistOptions(datalist, []);
      }
    };
    const deb = debounce(run, 200);
    remoteInput.addEventListener("input", deb);
    pathInput.addEventListener("input", deb);
    pathInput.addEventListener("focus", run);
  }

  const srcKind = document.getElementById("srcKind");
  if (srcKind) {
    applySrcKind(srcKind.value || "remote");
    srcKind.addEventListener("change", (e) => applySrcKind(e.target.value));
  }

  bindLocalDirSuggest(document.getElementById("srcLocalRoot"), document.getElementById("localPathList"));
  bindRemoteDirSuggest(document.getElementById("srcRemote"), document.getElementById("srcPath"), document.getElementById("srcPathList"));
  bindRemoteDirSuggest(document.getElementById("dstRemote"), document.getElementById("dstPath"), document.getElementById("dstPathList"));
</script>
{{end}}
