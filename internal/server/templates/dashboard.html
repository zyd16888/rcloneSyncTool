{{define "content"}}
<div class="page-title">概览</div>
<div class="page-subtitle">配置、规则、任务实时统计</div>

<div class="layui-row layui-col-space15">
  <div class="layui-col-md12">
    <div class="layui-card">
      <div class="layui-card-header">运行信息</div>
      <div class="layui-card-body">
        <div><span class="muted">rclone 配置：</span><b>{{.RcloneConfigPathDisplay}}</b></div>
        <div style="margin-top:6px"><span class="muted">日志目录：</span><b>{{.LogDir}}</b></div>
      </div>
    </div>
  </div>
</div>

<div class="layui-row layui-col-space15">
  <div class="layui-col-md12">
    <div class="layui-card">
      <div class="layui-card-header">整体传输统计</div>
      <div class="layui-card-body">
        <div style="margin-bottom:6px"><span class="muted">已传输总量：</span><b>{{humanBytes .TotalBytes}}</b></div>
        <div style="margin-bottom:6px"><span class="muted">当前总速度：</span><b>{{printf "%.1f" .TotalSpeed}} B/s</b></div>
        <div><span class="muted">运行中任务：</span><b>{{.RunningJobs}}</b></div>
      </div>
    </div>
  </div>
</div>

<div class="layui-row layui-col-space15">
  <div class="layui-col-md12">
    <div class="layui-card">
      <div class="layui-card-header">实时曲线</div>
      <div class="layui-card-body">
        <div class="layui-form" style="display:flex; gap:10px; align-items:center; flex-wrap: wrap; margin-bottom: 10px;">
          <div class="layui-input-inline" style="width:220px;">
            <select id="rtRule">
              <option value="">全局</option>
              {{range .Rules}}
                <option value="{{.Rule.ID}}">{{.Rule.ID}}</option>
              {{end}}
            </select>
          </div>
          <div class="layui-input-inline" style="width:160px;">
            <select id="rtWindow">
              <option value="900">最近 15 分钟</option>
              <option value="3600" selected>最近 1 小时</option>
              <option value="21600">最近 6 小时</option>
              <option value="86400">最近 24 小时</option>
            </select>
          </div>
          <div class="muted">提示：曲线不落库，仅在本页面打开后开始采样。</div>
        </div>
        <div class="muted" style="margin-bottom:6px">总速度</div>
        <canvas id="rtSpeed" style="width:100%; height:240px; border:1px solid #eee; border-radius:8px;"></canvas>
        <div class="muted" style="margin-top:12px; margin-bottom:6px">累计已传输</div>
        <canvas id="rtBytes" style="width:100%; height:240px; border:1px solid #eee; border-radius:8px;"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="layui-card">
  <div class="layui-card-header">同步规则</div>
  <div class="layui-card-body">
    <table class="layui-table" lay-skin="line">
  <tr>
    <th>ID</th>
    <th>启用</th>
    <th>模式</th>
    <th>映射</th>
    <th>并发</th>
    <th>统计</th>
  </tr>
  {{range .Rules}}
  <tr>
    <td><a href="/rules/edit?id={{.Rule.ID}}">{{.Rule.ID}}</a></td>
    <td>{{if .Rule.Enabled}}是{{else}}否{{end}}</td>
    <td>{{.Rule.TransferMode}}</td>
    <td class="muted">
      {{if eq .Rule.SrcKind "local"}}
        local:{{.Rule.SrcLocalRoot}} → {{.Rule.DstRemote}}:{{.Rule.DstPath}}
      {{else}}
        {{.Rule.SrcRemote}}:{{.Rule.SrcPath}} → {{.Rule.DstRemote}}:{{.Rule.DstPath}}
      {{end}}
    </td>
    <td class="muted">{{.Rule.MaxParallelJobs}}</td>
    <td class="muted">新={{.Counts.New}} 稳定={{.Counts.Stable}} 排队={{.Counts.Queued}} 传输中={{.Counts.Transferring}} 完成={{.Counts.Done}} 失败={{.Counts.Failed}}</td>
  </tr>
  {{end}}
    </table>
  </div>
</div>

<div class="layui-card">
  <div class="layui-card-header">最近任务</div>
  <div class="layui-card-body">
    <table class="layui-table" lay-skin="line">
  <tr>
    <th>任务 ID</th>
    <th>规则</th>
    <th>模式</th>
    <th>状态</th>
    <th>开始时间</th>
    <th>已传输</th>
    <th>速度</th>
  </tr>
  {{range .Jobs}}
  <tr>
    <td><a href="/jobs/view?id={{.Job.JobID}}">{{.Job.JobID}}</a></td>
    <td>{{.Job.RuleID}}</td>
    <td>{{.Job.TransferMode}}</td>
    <td>
      <span class="layui-badge {{if eq .Job.Status "running"}}layui-bg-green{{else if eq .Job.Status "failed"}}layui-bg-red{{else if eq .Job.Status "terminated"}}layui-bg-orange{{else}}layui-bg-blue{{end}}">{{.Job.Status}}</span>
    </td>
    <td class="muted">{{ts .Job.StartedAt}}</td>
    <td class="muted">{{if .HasM}}{{humanBytes .Metric.Bytes}}{{else}}{{humanBytes .Job.BytesDone}}{{end}}</td>
    <td class="muted">{{if .HasM}}{{printf "%.1f" .Metric.Speed}} B/s{{else}}{{printf "%.1f" .Job.AvgSpeed}} B/s{{end}}</td>
  </tr>
  {{end}}
    </table>

    <div class="toolbar" style="justify-content: space-between; margin-top: 10px;">
      <div class="muted">共 {{.JobsTotal}} 条，页大小 {{.JobsPageSize}}，第 {{.JobsPage}} / {{.JobsTotalPages}} 页</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <form class="layui-form" method="get" action="/" style="display:flex; gap:8px; align-items:center;">
          <div class="layui-input-inline" style="width:120px;">
            <select name="jobs_page_size" lay-filter="jobsPageSize">
              <option value="10" {{if eq .JobsPageSize 10}}selected{{end}}>10 / 页</option>
              <option value="20" {{if eq .JobsPageSize 20}}selected{{end}}>20 / 页</option>
              <option value="50" {{if eq .JobsPageSize 50}}selected{{end}}>50 / 页</option>
              <option value="100" {{if eq .JobsPageSize 100}}selected{{end}}>100 / 页</option>
            </select>
          </div>
          <div class="layui-input-inline" style="width:120px;">
            <input type="number" min="1" max="{{.JobsTotalPages}}" name="jobs_page" value="{{.JobsPage}}" class="layui-input" placeholder="跳转页码">
          </div>
          <button class="layui-btn layui-btn-primary layui-btn-sm" type="submit">跳转</button>
        </form>
        {{if .JobsHasPrev}}
          <a class="layui-btn layui-btn-primary layui-btn-sm" href="{{.JobsPrevURL}}">上一页</a>
        {{else}}
          <span class="layui-btn layui-btn-disabled layui-btn-sm">上一页</span>
        {{end}}
        {{if .JobsHasNext}}
          <a class="layui-btn layui-btn-primary layui-btn-sm" href="{{.JobsNextURL}}">下一页</a>
        {{else}}
          <span class="layui-btn layui-btn-disabled layui-btn-sm">下一页</span>
        {{end}}
        <a class="layui-btn layui-btn-sm" href="/jobs">打开任务列表</a>
      </div>
    </div>
  </div>
</div>

<script src="/static/realtime_chart.js"></script>
<script>
  layui.use(['form'], function(){
    const form = layui.form;
    form.render();
    form.on('select(jobsPageSize)', function(){
      const f = document.querySelector('form[action="/"]');
      if (f) f.submit();
    });
  });

  const intervalMs = 2000;
  const rtRule = document.getElementById("rtRule");
  const rtWindow = document.getElementById("rtWindow");
  const speedCanvas = document.getElementById("rtSpeed");
  const bytesCanvas = document.getElementById("rtBytes");
  const speedChart = createLineChart(speedCanvas, { color: "#16baaa" });
  const bytesChart = createLineChart(bytesCanvas, { color: "#1e9fff" });
  let pointsSpeed = [];
  let pointsBytes = [];

  function canvasFit(canvas) {
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    const w = Math.max(200, Math.floor(rect.width * dpr));
    const h = Math.max(160, Math.floor(rect.height * dpr));
    if (canvas.width !== w) canvas.width = w;
    if (canvas.height !== h) canvas.height = h;
  }

  function humanBytes(n) {
    const u = 1024;
    if (n < u) return n + " B";
    const units = ["KiB","MiB","GiB","TiB","PiB"];
    let i = -1;
    let v = n;
    while (v >= u && i < units.length - 1) { v /= u; i++; }
    return v.toFixed(1) + " " + units[i];
  }
  function humanSpeed(n) { return humanBytes(n) + "/s"; }

  function capPoints() {
    const windowSec = parseInt(rtWindow.value || "3600", 10);
    const maxPoints = Math.max(10, Math.floor(windowSec * 1000 / intervalMs));
    if (pointsSpeed.length > maxPoints) {
      pointsSpeed = pointsSpeed.slice(pointsSpeed.length - maxPoints);
    }
    if (pointsBytes.length > maxPoints) {
      pointsBytes = pointsBytes.slice(pointsBytes.length - maxPoints);
    }
  }

  async function tick() {
    const ruleID = rtRule.value || "";
    const r = await fetch("/api/stats/now?rule_id=" + encodeURIComponent(ruleID));
    if (!r.ok) return;
    const d = await r.json();
    pointsSpeed.push({ x: d.ts, y: d.speedTotal || 0 });
    pointsBytes.push({ x: d.ts, y: d.bytesTotal || 0 });
    capPoints();
    canvasFit(speedCanvas);
    canvasFit(bytesCanvas);
    speedChart.draw(pointsSpeed, (v) => humanSpeed(v));
    bytesChart.draw(pointsBytes, (v) => humanBytes(v));
  }

  function reset() {
    pointsSpeed = [];
    pointsBytes = [];
    canvasFit(speedCanvas);
    canvasFit(bytesCanvas);
    speedChart.draw(pointsSpeed, (v) => humanSpeed(v));
    bytesChart.draw(pointsBytes, (v) => humanBytes(v));
  }

  rtRule.addEventListener("change", reset);
  rtWindow.addEventListener("change", reset);
  window.addEventListener("resize", () => {
    canvasFit(speedCanvas);
    canvasFit(bytesCanvas);
    speedChart.draw(pointsSpeed, (v) => humanSpeed(v));
    bytesChart.draw(pointsBytes, (v) => humanBytes(v));
  });
  reset();
  tick();
  setInterval(tick, intervalMs);
</script>
{{end}}
