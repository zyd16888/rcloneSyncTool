{{define "content"}}
<div class="page-title">任务列表</div>
<div class="page-subtitle">每个任务对应一个独立的 rclone 进程与 RC 端口，统计互相隔离</div>

<div class="layui-card">
  <div class="layui-card-body">
    <form class="layui-form" method="get" action="/jobs" style="margin-bottom: 10px;">
      <input type="hidden" name="page" value="1">
      <div class="layui-form-item" style="margin-bottom: 0;">
        <div class="layui-inline">
          <label class="layui-form-label" style="width: 60px;">规则</label>
          <div class="layui-input-inline" style="width: 160px;">
            <select name="rule_id">
              <option value="">全部</option>
              {{range .Rules}}
                <option value="{{.ID}}" {{if eq $.F.RuleID .ID}}selected{{end}}>{{.ID}}</option>
              {{end}}
            </select>
          </div>
        </div>
        <div class="layui-inline">
          <label class="layui-form-label" style="width: 60px;">状态</label>
          <div class="layui-input-inline" style="width: 140px;">
            <select name="status">
              <option value="" {{if eq .F.Status ""}}selected{{end}}>全部</option>
              <option value="running" {{if eq .F.Status "running"}}selected{{end}}>running</option>
              <option value="done" {{if eq .F.Status "done"}}selected{{end}}>done</option>
              <option value="failed" {{if eq .F.Status "failed"}}selected{{end}}>failed</option>
              <option value="terminated" {{if eq .F.Status "terminated"}}selected{{end}}>terminated</option>
            </select>
          </div>
        </div>
        <div class="layui-inline">
          <label class="layui-form-label" style="width: 60px;">模式</label>
          <div class="layui-input-inline" style="width: 140px;">
            <select name="mode">
              <option value="" {{if eq .F.TransferMode ""}}selected{{end}}>全部</option>
              <option value="copy" {{if eq .F.TransferMode "copy"}}selected{{end}}>copy</option>
              <option value="move" {{if eq .F.TransferMode "move"}}selected{{end}}>move</option>
            </select>
          </div>
        </div>
        <div class="layui-inline">
          <label class="layui-form-label" style="width: 60px;">关键字</label>
          <div class="layui-input-inline" style="width: 220px;">
            <input type="text" name="q" value="{{.F.Query}}" class="layui-input" placeholder="任务ID/错误关键字">
          </div>
        </div>
        <div class="layui-inline">
          <label class="layui-form-label" style="width: 60px;">页大小</label>
          <div class="layui-input-inline" style="width: 120px;">
            <select name="page_size" lay-filter="pageSize">
              <option value="10" {{if eq .PageSize 10}}selected{{end}}>10 / 页</option>
              <option value="20" {{if eq .PageSize 20}}selected{{end}}>20 / 页</option>
              <option value="50" {{if eq .PageSize 50}}selected{{end}}>50 / 页</option>
              <option value="100" {{if eq .PageSize 100}}selected{{end}}>100 / 页</option>
            </select>
          </div>
        </div>
        <div class="layui-inline">
          <button class="layui-btn layui-btn-sm" type="submit">筛选</button>
          <a class="layui-btn layui-btn-primary layui-btn-sm" href="/jobs">重置</a>
        </div>
      </div>
    </form>

    <table class="layui-table" lay-skin="line">
  <tr>
    <th>任务 ID</th>
    <th>规则</th>
    <th>模式</th>
    <th>状态</th>
    <th>开始</th>
    <th>结束</th>
    <th>已传输</th>
    <th>速度</th>
    <th>错误</th>
    <th>操作</th>
  </tr>
  {{range .Jobs}}
  <tr>
    <td><a href="/jobs/view?id={{.Job.JobID}}">{{.Job.JobID}}</a></td>
    <td>{{if hasPrefix .Job.RuleID "manual_"}}手动运行{{else}}{{.Job.RuleID}}{{end}}</td>
    <td>{{.Job.TransferMode}}</td>
    <td><span class="layui-badge {{if eq .Job.Status "running"}}layui-bg-green{{else if eq .Job.Status "failed"}}layui-bg-red{{else if eq .Job.Status "terminated"}}layui-bg-orange{{else}}layui-bg-blue{{end}}">{{.Job.Status}}</span></td>
    <td class="muted">{{ts .Job.StartedAt}}</td>
    <td class="muted">{{ts .Job.EndedAt}}</td>
    <td class="muted">{{if .HasM}}{{humanBytes .Metric.Bytes}}{{else}}{{humanBytes .Job.BytesDone}}{{end}}</td>
    <td class="muted">{{if .HasM}}{{printf "%.1f" .Metric.Speed}} B/s{{else}}{{printf "%.1f" .Job.AvgSpeed}} B/s{{end}}</td>
    <td class="muted">{{.Job.Error}}</td>
    <td>
      {{if eq .Job.Status "running"}}
        <form class="inline" method="post" action="/jobs/terminate" onsubmit="return confirm('确定要终止该任务吗？');">
          <input type="hidden" name="id" value="{{.Job.JobID}}">
          <input type="hidden" name="next" value="{{$.SelfURL}}">
          <button class="layui-btn layui-btn-danger layui-btn-sm" type="submit">终止</button>
        </form>
      {{else}}
        <span class="muted">-</span>
      {{end}}
    </td>
  </tr>
  {{end}}
    </table>

    <div class="toolbar" style="justify-content: space-between; margin-top: 10px;">
      <div class="muted">共 {{.Total}} 条，页大小 {{.PageSize}}，第 {{.Page}} / {{.TotalPages}} 页</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <form class="layui-form" method="get" action="/jobs" style="display:flex; gap:8px; align-items:center;">
          <input type="hidden" name="page_size" value="{{.PageSize}}">
          <input type="hidden" name="rule_id" value="{{.F.RuleID}}">
          <input type="hidden" name="status" value="{{.F.Status}}">
          <input type="hidden" name="mode" value="{{.F.TransferMode}}">
          <input type="hidden" name="q" value="{{.F.Query}}">
          <div class="layui-input-inline" style="width:120px;">
            <input type="number" min="1" max="{{.TotalPages}}" name="page" value="{{.Page}}" class="layui-input" placeholder="跳转页码">
          </div>
          <button class="layui-btn layui-btn-primary layui-btn-sm" type="submit">跳转</button>
        </form>
        {{if .HasPrev}}
          <a class="layui-btn layui-btn-primary layui-btn-sm" href="{{.PrevURL}}">上一页</a>
        {{else}}
          <span class="layui-btn layui-btn-disabled layui-btn-sm">上一页</span>
        {{end}}
        {{if .HasNext}}
          <a class="layui-btn layui-btn-primary layui-btn-sm" href="{{.NextURL}}">下一页</a>
        {{else}}
          <span class="layui-btn layui-btn-disabled layui-btn-sm">下一页</span>
        {{end}}
      </div>
    </div>
  </div>
</div>

<script>
  layui.use(['form'], function(){
    const form = layui.form;
    form.render();
    form.on('select(pageSize)', function(data){
      const f = data.elem ? data.elem.closest('form') : null;
      if (f) f.submit();
    });
  });

  // Fallback (in case Layui select event doesn't fire)
  document.addEventListener('change', (e) => {
    const t = e.target;
    if (!t || t.tagName !== 'SELECT') return;
    if (t.name !== 'page_size') return;
    const f = t.closest('form');
    if (f) f.submit();
  }, true);
</script>
{{end}}
