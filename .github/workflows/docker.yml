name: docker

on:
  workflow_dispatch: {}
  push:
    tags:
      - "v*"

permissions:
  contents: read
  packages: write

jobs:
  build-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare image name
        run: echo "IMAGE_NAME=ghcr.io/${GITHUB_REPOSITORY,,}" >> "$GITHUB_ENV"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute tags
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            ver="${GITHUB_REF_NAME}"
            echo "OFFICIAL_TAGS=${IMAGE_NAME}:${ver},${IMAGE_NAME}:latest" >> "$GITHUB_ENV"
            echo "WISERAIN_TAGS=${IMAGE_NAME}:${ver}-115,${IMAGE_NAME}:latest-115" >> "$GITHUB_ENV"
          else
            echo "OFFICIAL_TAGS=${IMAGE_NAME}:latest" >> "$GITHUB_ENV"
            echo "WISERAIN_TAGS=${IMAGE_NAME}:latest-115" >> "$GITHUB_ENV"
          fi

      - name: Build and push (official rclone)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          target: runtime-official
          tags: ${{ env.OFFICIAL_TAGS }}

      - name: Resolve wiserain rclone release assets
        shell: bash
        run: |
          set -euo pipefail
          api="https://api.github.com/repos/wiserain/rclone/releases/latest"
          json="$(curl -fsSL "$api")"
          has_amd64="$(echo "$json" | jq -r '[.assets[]?.name] | any(.[]; test("linux[-_]?amd64\\.zip$"; "i"))')"
          has_arm64="$(echo "$json" | jq -r '[.assets[]?.name] | any(.[]; test("linux[-_]?arm64\\.zip$"; "i"))')"
          has_armv6="$(echo "$json" | jq -r '[.assets[]?.name] | any(.[]; test("linux[-_]?arm[-_]?v6\\.zip$"; "i"))')"

          if [[ "$has_amd64" != "true" ]]; then
            echo "wiserain latest release has no linux-amd64.zip asset, cannot build 115 image." >&2
            exit 1
          fi

          platforms="linux/amd64"
          if [[ "$has_arm64" == "true" ]]; then
            platforms="linux/amd64,linux/arm64"
          elif [[ "$has_armv6" == "true" ]]; then
            platforms="linux/amd64,linux/arm/v6"
          fi

          echo "WISERAIN_PLATFORMS=$platforms" >> "$GITHUB_ENV"

      - name: Build and push (wiserain 115 rclone)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: ${{ env.WISERAIN_PLATFORMS }}
          target: runtime-115
          tags: ${{ env.WISERAIN_TAGS }}
