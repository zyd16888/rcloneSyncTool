{{define "content"}}
<div class="space-y-4">
  <div class="flex flex-wrap gap-2 items-center justify-between">
    <div>
      <h1 class="text-xl font-bold">任务详情</h1>
      <div class="text-sm opacity-70">实时速率/流量来自该任务独占的 RC 端口</div>
    </div>
    <div class="flex gap-2">
      <a class="btn btn-outline btn-sm" href="/jobs">返回任务列表</a>
      {{if eq .Job.Status "running"}}
      <form class="inline" method="post" action="/jobs/terminate" onsubmit="return confirm('确定要终止该任务吗？');">
        <input type="hidden" name="id" value="{{.Job.JobID}}">
        <input type="hidden" name="next" value="/jobs/view?id={{.Job.JobID}}">
        <button class="btn btn-error btn-sm" type="submit">终止任务</button>
      </form>
      {{end}}
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
    <div class="card bg-base-100 shadow">
      <div class="card-body">
        <div class="card-title text-base">基础信息</div>
        <div class="text-sm"><b>任务 ID：</b><span class="opacity-70">{{.Job.JobID}}</span></div>
        <div class="text-sm"><b>规则：</b><span class="opacity-70">{{if hasPrefix .Job.RuleID "manual_"}}手动运行{{else}}{{.Job.RuleID}}{{end}}</span></div>
        <div class="text-sm"><b>模式：</b><span class="opacity-70">{{.Job.TransferMode}}</span></div>
        <div class="text-sm">
          <b>状态：</b>
          <span class="badge {{if eq .Job.Status "running"}}badge-success{{else if eq .Job.Status "failed"}}badge-error{{else if eq .Job.Status "terminated"}}badge-warning{{else}}badge-info{{end}}">{{.Job.Status}}</span>
        </div>
        <div class="text-sm"><b>开始：</b><span class="opacity-70">{{ts .Job.StartedAt}}</span></div>
        <div class="text-sm"><b>结束：</b><span class="opacity-70">{{ts .Job.EndedAt}}</span></div>
        <div class="text-sm"><b>RC 端口：</b><span class="opacity-70">{{.Job.RcPort}}</span></div>
        <div class="text-sm" style="word-break: break-all;"><b>日志：</b><span class="opacity-70">{{.Job.LogPath}}</span></div>
        <div class="text-sm mt-2" style="word-break: break-all;">
          <b>映射：</b>
          <span class="opacity-70">
            {{if eq .Rule.SrcKind "local"}}
              local:{{.Rule.SrcLocalRoot}} → {{.Rule.DstRemote}}:{{.Rule.DstPath}}
            {{else}}
              {{.Rule.SrcRemote}}:{{.Rule.SrcPath}} → {{.Rule.DstRemote}}:{{.Rule.DstPath}}
            {{end}}
          </span>
        </div>
      </div>
    </div>

    <div class="card bg-base-100 shadow">
      <div class="card-body">
        <div class="card-title text-base">实时统计</div>
        <div class="grid grid-cols-2 gap-3 text-sm">
          <div><b>已传输：</b><span id="bytes" class="opacity-70">-</span></div>
          <div><b>当前速度：</b><span id="speed" class="opacity-70">-</span></div>
          <div><b>并发传输数：</b><span id="transfers" class="opacity-70">-</span></div>
          <div><b>错误数：</b><span id="errors" class="opacity-70">-</span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <div class="card-title text-base">当前传输文件</div>
      <div class="overflow-x-auto">
        <table class="table table-zebra">
          <thead>
            <tr>
              <th>文件</th>
              <th style="width:260px">进度</th>
              <th style="width:180px">已传/总计</th>
              <th style="width:140px">速度</th>
              <th style="width:110px">ETA</th>
            </tr>
          </thead>
          <tbody id="transfersBody"></tbody>
        </table>
      </div>
      <div id="transfersHint" class="text-sm opacity-70">-</div>
    </div>
  </div>

  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <div class="card-title text-base">实时日志</div>
      <pre id="logBox" class="bg-neutral text-neutral-content rounded-xl p-3 text-xs leading-relaxed overflow-auto" style="max-height: 360px;"></pre>
      <div class="text-sm opacity-70 mt-2">日志来源：{{.Job.LogPath}}</div>
    </div>
  </div>
</div>

<script>
  const jobID = "{{.Job.JobID}}";
  function humanBytes(n) {
    const u = 1024;
    if (n < u) return n + " B";
    const units = ["KiB","MiB","GiB","TiB","PiB"];
    let i = -1;
    let v = n;
    while (v >= u && i < units.length - 1) { v /= u; i++; }
    return v.toFixed(1) + " " + units[i];
  }
  function humanSpeed(n) { return humanBytes(n) + "/s"; }
  function humanETA(sec) {
    if (!isFinite(sec) || sec <= 0) return "-";
    const s = Math.floor(sec);
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const r = s % 60;
    if (h > 0) return h + "h " + m + "m";
    if (m > 0) return m + "m " + r + "s";
    return r + "s";
  }

  async function refresh() {
    const r = await fetch("/api/job?id=" + encodeURIComponent(jobID));
    if (!r.ok) return;
    const d = await r.json();
    if (!d.hasMetric) return;
    document.getElementById("bytes").textContent = humanBytes(d.metric.Bytes);
    document.getElementById("speed").textContent = humanSpeed(d.metric.Speed);
    document.getElementById("transfers").textContent = d.metric.Transfers;
    document.getElementById("errors").textContent = d.metric.Errors;
  }
  refresh();
  setInterval(refresh, 1000);

  async function refreshTransfers() {
    const body = document.getElementById("transfersBody");
    const hint = document.getElementById("transfersHint");
    const r = await fetch("/api/job/transfers?id=" + encodeURIComponent(jobID));
    if (!r.ok) return;
    const d = await r.json();
    const list = d.transfers || [];
    if (!d.running) {
      body.innerHTML = "";
      hint.textContent = "任务未运行，暂无实时传输列表。";
      return;
    }
    if (d.error) {
      body.innerHTML = "";
      hint.textContent = "获取失败：" + d.error;
      return;
    }
    if (list.length === 0) {
      body.innerHTML = "";
      hint.textContent = "当前无正在传输的文件（可能在 check/idle 或已接近完成）。";
      return;
    }
    hint.textContent = "实时来源：rclone " + (d.source || "core/stats.transferring");
    body.innerHTML = list.map((t) => {
      const size = t.size || 0;
      const bytes = t.bytes || 0;
      const pct = size > 0 ? Math.max(0, Math.min(100, (bytes * 100 / size))) : 0;
      const bar = '<progress class="progress progress-success w-full" value="' + pct.toFixed(1) + '" max="100"></progress>';
      return '<tr>' +
        '<td class="opacity-70" style="word-break:break-all">' + (t.name || '') + '</td>' +
        '<td>' + bar + '</td>' +
        '<td class="opacity-70">' + humanBytes(bytes) + ' / ' + humanBytes(size) + '</td>' +
        '<td class="opacity-70">' + humanSpeed(t.speed || 0) + '</td>' +
        '<td class="opacity-70">' + humanETA(t.eta || 0) + '</td>' +
        '</tr>';
    }).join("");
  }
  refreshTransfers();
  setInterval(refreshTransfers, 1000);

  // Log stream (SSE)
  const logBox = document.getElementById("logBox");
  function appendLog(text) {
    if (!text) return;
    logBox.textContent += text;
    if (!text.endsWith("\n")) logBox.textContent += "\n";
    logBox.scrollTop = logBox.scrollHeight;
  }
  const es = new EventSource("/api/job/log/stream?id=" + encodeURIComponent(jobID));
  es.addEventListener("log", (e) => appendLog(e.data));
  es.addEventListener("done", () => { es.close(); });
  es.onerror = () => { /* keep trying */ };
</script>
{{end}}
